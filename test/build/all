# SPDX-License-Identifier: AGPL-3.0-or-later
#
# PASST - Plug A Simple Socket Transport
#  for qemu/UNIX domain socket mode
#
# PASTA - Pack A Subtle Tap Abstraction
#  for network namespace/tap device mode
#
# test/build/all - Build targets, one by one, then all together, check output
#
# Copyright (c) 2021 Red Hat GmbH
# Author: Stefano Brivio <sbrivio@redhat.com>

htools	make cc rm uname getconf mkdir cp rm man

test	Build passt
host	make clean
check	! [ -e passt ]
host	CFLAGS="-Werror" make passt
check	[ -f passt ]

test	Build pasta
host	make clean
check	! [ -e pasta ]
host	CFLAGS="-Werror" make pasta
check	[ -h pasta ]

test	Build qrap
host	make clean
check	! [ -e qrap ]
host	CFLAGS="-Werror" make qrap
check	[ -f qrap ]

test	Build all
host	make clean
check	! [ -e passt ]
check	! [ -e pasta ]
check	! [ -e qrap ]
host	CFLAGS="-Werror" make
check	[ -f passt ]
check	[ -h pasta ]
check	[ -f qrap ]

tempdir	TEMP

test	Install
host	prefix=__TEMP__ make install
check	[ -f __TEMP__/bin/passt ]
check	[ -h __TEMP__/bin/pasta ]
check	[ -f __TEMP__/bin/qrap ]
check	man -M __TEMP__/share/man -W passt
check	man -M __TEMP__/share/man -W pasta
check	man -M __TEMP__/share/man -W qrap

test	Uninstall
host	prefix=__TEMP__ make uninstall
check	! [ -f __TEMP__/bin/passt ]
check	! [ -h __TEMP__/bin/pasta ]
check	! [ -f __TEMP__/bin/qrap ]
check	! man -M __TEMP__/share/man -W passt 2>/dev/null
check	! man -M __TEMP__/share/man -W pasta 2>/dev/null
check	! man -M __TEMP__/share/man -W qrap 2>/dev/null
